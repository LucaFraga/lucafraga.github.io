<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello Bulma!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css">
    <script src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <style>
    body {
      background-
    }
  </style>
  </head>
  <body>
  <section class="section">
    <div class="container">
    </div>
  </section>
  <script defer>
		/* Configuration - Edit as needed */
		var entries = {
			Info : {type:'separator'},
			Nome : {type:'text',current_value:'Giocatore'},
			Razza : {type:'text',current_value:'Umano'},
			Stato : {type:'separator'},
      PS : {type:'number',current_value:100},
			PS_MAX : {type:'readonly',current_value:100},
      PM : {type:'number',current_value:30},
      PM_MAX : {type:'readonly',current_value:30},
      Attacco_Fisico : {type:'readonly',current_value:4},
			Attacco_Magico : {type:'readonly',current_value:4},
      Stamina : {type:'number',current_value:100},
			Stamina_MAX : {type:'readonly',current_value:100},
			Note : {type:'text',current_value:''},
			Build : {type:'separator'},
			Livello : {type:'number',current_value:1},
      Esperienza : {type:'number',current_value:0},
			EXP_Livello : {type:'readonly',current_value:1000},
      Bonus_PS : {type:'number',current_value:0},
      Bonus_PM: {type:'number',current_value:0},
			Forza : {type:'number',current_value:0},
			Destrezza: {type:'number',current_value:0},
			Intelligenza : {type:'number',current_value:0},
			Saggezza : {type:'number',current_value:0},
      Bonus_Equipaggiamento : {type:'separator'},
      PS_Equip : {type:'number',current_value:0},
      PM_Equip : {type:'number',current_value:0},
      ATK_Equip : {type:'number',current_value:0},
      ATK_Magico_Equip : {type:'number',current_value:0},
		};

    /* Valori base */
    var PS_BASE = 100;
    var PS_LEVEL = 10;
    var PS_POINTS = [0,0.05,0.10,0.15,0.20,0.25,0.30,0.35,0.40,0.45,0.50,0.55,0.60,0.65];
    var PM_POINTS = [0,0.05,0.10,0.15,0.20,0.25,0.30,0.35,0.40,0.45,0.50,0.55,0.60,0.65];
    var PM_BASE = 30;
    var PM_LEVEL = 3;
    function ricalcolaMP() {
        var livello = parseInt(getValue("Livello"))-1;
        var bonusPM = PM_POINTS[parseInt(getValue("Bonus_PM"))];
        var PM_Equip = parseInt(getValue("PM_Equip"));

        var result = PM_BASE + (livello * PM_LEVEL);
        result += (result * bonusPM);
        result += PM_Equip;
        setValue("PM_MAX", Math.floor(result));

    }
    function ricalcolaHP() {
        var livello = parseInt(getValue("Livello"))-1;
        var bonusPS = PS_POINTS[parseInt(getValue("Bonus_PS"))];
        var PS_Equip = parseInt(getValue("PS_Equip"));

        var result = PS_BASE + (livello * PS_LEVEL);
        result += (result * bonusPS);
        result += PS_Equip;
        setValue("PS_MAX", Math.floor(result));

    }
		/* Custom logic - Edit as needed */
    function onChange(element, name, value) {
      if(name === 'Livello' || name === 'Bonus_PS' || name === 'PS_Equip')
        ricalcolaHP();
      if(name === 'Livello' || name === 'Bonus_PM' || name === 'PM_Equip')
        ricalcolaMP();
    }

		/* Load/Save logic - You can leave this as-is */
    function set(name, value) {

    }
		function createElement(name, type, default_value, container) {
			var friendlyName = name.replace('_', ' ')
			var html = "";
      var attrs = "";
      var cls = "";
      var pre_addons = "";
      var post_addons = "";
      var inject = "";
      var addons = "";
			if(false) {
          html = `<div class="has-text-centered"><h3 class="subtitle">${friendlyName}</h3></div>`;
			} else {
        if(type ==='number') {
          //attrs += 'readonly ';
          pre_addons = `<div class="control">
              <a class="button minus_five" data-item="${name}_input">
                <<
              </a>
            </div>
            <div class="control">
                <a class="button minus_one" data-item="${name}_input">
                  <
                </a>
            </div>`;
            post_addons = `<div class="control">
                <a class="button plus_one" data-item="${name}_input">
                  >
                </a>
              </div>
              <div class="control">
                  <a class="button plus_five" data-item="${name}_input">
                    >>
                  </a>
              </div>`;
      }
      if (type === 'readonly' ) {
        attrs += 'readonly';
        cls += 'is-static';
      } else if(type === 'separator') {
        cls += 'is-hidden';
        inject = "--------------------";
      }

        if(pre_addons !== "" || post_addons !== "") {
          addons = "has-addons";
        }
				html = `<div class="field is-horizontal" id="${name}_field">
                  <div class="field-label is-normal">
                      <label class="label">${friendlyName}</label>
                  </div>
                  <div class="field-body">
                    <div class="field ${addons}" data-item="${name}_input">
                      ${pre_addons}
                      <div class="control is-expanded">
                        ${inject}
                        <input class="input ${cls}" id="${name}_input" ${attrs} type="${type}" placeholder="${friendlyName}" value="${default_value}" data-name="${name}">
                      </div>
                      ${post_addons}
                    </div>
                  </div>
						</div>`;
			}
			container.append(html);
		}
    function getValue(name) {
      return entries[name].current_value;
    }
		function setValue(name, value) {
      var el = $(`#${name}_input`)
      el.val(value);
      el.trigger("change");
		}

    function changeVal(e,i) {
      var selector = $(e.target).data('item');
      var el = $(`#${selector}`)
      var val = parseInt(el.val());
      el.val(val+i);
      el.trigger("change");
    }
    function saveData() {
      console.log("Saving data");
      for (var key in entries) {
				// check if the property/key is defined in the object itself, not in parent
				if (entries.hasOwnProperty(key)) {
          if (entries[key].type === "separator") continue;
					var currentValue = $(`input#${key}_input`).val();

          entries[key].current_value = currentValue;
				}
        window.localStorage.setItem('saved_data',  JSON.stringify(entries));

			}
    }
		function initialize() {
			var container = $(".container");
      var _savedData = window.localStorage.getItem('saved_data');
      var savedData = null;
      if (_savedData !== null) {
        try{
          savedData = JSON.parse(_savedData);
        } catch {}
      }
      console.log(savedData);
      console.log(entries);
			for (var key in entries) {
				// check if the property/key is defined in the object itself, not in parent
				if (entries.hasOwnProperty(key)) {
					var value = entries[key];
          var currentValue = value.current_value;
          if(savedData !== null && savedData.hasOwnProperty(key))
            currentValue = savedData[key].current_value;
					createElement(key, value.type, currentValue, container);
				}


			}

      $('.button.plus_one').click(function(e){changeVal(e,1)});
      $('.button.plus_five').click(function(e){changeVal(e,5)});
      $('.button.minus_one').click(function(e){changeVal(e,-1)});
      $('.button.minus_five').click(function(e){changeVal(e,-5)});
      $('input').change(saveData);
      $('input').change(function(e) {
            var el = $(e.target);
            onChange(el, el.data('name'), el.val());
      });
		}

		$("document").ready(initialize);

	</script>
  </body>
</html>
